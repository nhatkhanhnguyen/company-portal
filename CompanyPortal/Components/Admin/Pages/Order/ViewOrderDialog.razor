@using CompanyPortal.CQRS.Orders.Queries
@using CompanyPortal.Core.Common
@using CompanyPortal.Core.Enums
@using CompanyPortal.Core.Extensions
@using System.Globalization
@using MediatR

@inject IMediator Mediator

<ModalDialog SizeClass="modal-xl">
    <Header>
        <h5 class="modal-title">THÔNG TIN ĐƠN HÀNG</h5>
        <button type="button" class="btn-close" aria-label="Close" @onclick="Cancel"></button>
    </Header>
    <Body>
        <p>Mã đơn hàng <b>@Order.ExternalId</b></p>
        <p>Ngày giờ đặt <b>@Order.DateCreated.ToString("G")</b></p>
        <p>Người đặt <b>@Order.Fullname</b></p>

        <div class="table-responsive mt-2">
            @if (_isLoading)
            {
                <Spinner></Spinner>
            }
            else
            {
                <table class="table table-striped table-hover align-middle">
                    <tbody>
                        @if (Order.OrderDetails.Count() > 0)
                        {
                            foreach (var orderDetail in Order.OrderDetails)
                            {
                                <tr>
                                    <td width="150px">
                                        <img src="@orderDetail.ProductImageUrl" alt="@orderDetail.ProductName" class="img-fluid" />
                                    </td>
                                    <td>
                                        <b>@orderDetail.ProductName</b>
                                    </td>
                                    <td>
                                        Số lượng: <b>@orderDetail.Quantity</b>
                                    </td>
                                    <td>
                                        Tổng: <b>@orderDetail.Total.ToString("C", CultureInfo.GetCultureInfo("vi-vn"))</b>
                                    </td>
                                </tr>
                            }
                            <tr>
                                <td colspan="2"><b>TỔNG</b></td>
                                <td>
                                    Số lượng: <b>@Order.OrderDetails.Sum(x => x.Quantity)</b>
                                </td>
                                <td>
                                    Tổng: <b>@Order.Total.ToString("C", CultureInfo.GetCultureInfo("vi-vn"))</b>
                                </td>
                            </tr>
                        }
                        else
                        {
                            <tr>
                                <td colspan="3" class="text-center">KHÔNG CÓ SẢN PHẨM</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </div>

        <p class="fw-bold">Trạng thái đơn hàng</p>
        <div class="progress rounded-pill mb-2" role="progressbar" aria-label="Basic example" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="height: 30px">
            <div class="progress-bar progress-bar-striped progress-bar-animated bg-warning" style="width: @Order.Progress"></div>
        </div>
        <div class="row">
            @foreach (var item in _orderStatus)
            {
                <div class="col-2 text-center text-wrap">@item.DisplayName</div>
            }
        </div>
    </Body>
</ModalDialog>

<style>
    .table img {
        width: 100px
    }
</style>

@code {
    [CascadingParameter] BlazoredModalInstance BlazoredModal { get; set; } = default!;
    private List<EnumToRecord<OrderStatus>> _orderStatus = Enum.GetValues<OrderStatus>().Select(e => new EnumToRecord<OrderStatus>(e.GetDescription(), e)).ToList();

    public OrderViewModel Order { get; set; } = new()
        {
            Address = "askdhjakjshdkjahsd",
            DateCreated = DateTimeOffset.Now,
            Email = "test@gmail.com",
            Fullname = "GALVIN NGUYEN",
            PhoneNumber = "918723987",
            ExternalId = "ORDER-123",
            Id = 1,
            Total = 18273122,
            OrderDetails = new List<OrderDetailViewModel>
        {
            new(1, "TEST 1", "https://img.freepik.com/free-photo/top-view-cosmetic-products_23-2148549123.jpg", 10, 1000),
            new(2, "TEST 2", "https://img.freepik.com/free-photo/cosmetic-containers-with-orange_23-2148549144.jpg", 100, 10000),
        },
            Status = OrderStatus.Confirmed
        };
    private bool _isLoading;

    private void Cancel() => BlazoredModal.CancelAsync();

    protected override async Task OnInitializedAsync()
    {
        // if (Order != null)
        // {
        //     _isLoading = true;
        //     Order.OrderDetails = await Mediator.Send(new GetOrderDetailByIdQuery(Order.Id, true));
        //     _isLoading = false;
        // }
    }
}
